# 策略配置页面设计文档

## 1. 概述

本文档概述了多标的回测系统中策略配置页面的设计改进方案。当前实现在配置多标的策略时存在可用性问题，会同时显示单标的和多标的配置选项，导致用户困惑。

## 2. 现有问题分析

### 2.1 问题描述
- **界面混乱**：选择多个标的时，默认策略配置和个别标的策略配置同时显示
- **配置冗余**：用户需要在多个地方配置策略，不清楚优先级关系
- **用户体验差**：没有清晰的视觉层次来表明哪个配置生效

### 2.2 当前实现问题
```python
// backtesting.py:84-89 中的问题流程
strategy_ui.render_strategy_selection_ui()                    // 默认策略（总是显示）
strategy_ui.render_custom_rules_ui()                          // 默认自定义规则（总是显示）
strategy_ui.render_multi_symbol_strategy_ui()                 // 多标配置（仅当数量>1时显示）
```

## 3. 设计目标

### 3.1 主要目标
1. **清晰的视觉层次**：区分单标的和多标的配置模式
2. **直观的工作流程**：根据用户选择引导配置过程
3. **一致的体验**：无论标的数量多少都提供协调的界面
4. **灵活的配置**：支持简单和高级配置场景

### 3.2 成功指标
- 减少策略配置过程中的用户困惑
- 提高多标场景的配置速度
- 明确策略优先级和继承关系
- 提升用户满意度，减少支持请求

## 4. 设计方案

### 4.1 自适应UI架构

#### 4.1.1 单标模式
```python
// 当选择1个标的时
if len(selected_options) == 1:
    render_single_asset_strategy_config()
```

**组件包括：**
- 默认策略类型选择
- 自定义规则配置（如适用）
- 仓位管理设置
- 清晰标注单标配置

#### 4.1.2 多标模式
```python
// 当选择2+个标的时
if len(selected_options) > 1:
    render_multi_asset_strategy_config()
```

**组件包括：**
- 全局默认策略配置
- 个别标的策略覆盖选项
- 策略继承机制
- 批量配置功能

### 4.2 配置层次结构

#### 4.2.1 策略优先级
1. **个别标的策略**（最高优先级）
2. **全局默认策略**（后备选项）
3. **系统默认策略**（最低优先级）

#### 4.2.2 视觉层次
```
多标策略配置
├── 全局默认设置（始终折叠，可选）
│   ├── 策略类型
│   ├── 默认规则
│   └── 仓位设置
└── 个别标的具体配置
    ├── [+] 标的1 - 使用全局默认
    ├── [+] 标的2 - 自定义策略
    └── [+] 标的3 - 规则组策略
```

### 4.3 改进的用户流程

#### 4.3.1 动态UI适配
```python
def render_strategy_configuration():
    asset_count = len(selected_options)

    if asset_count == 0:
        render_empty_state()
    elif asset_count == 1:
        render_single_asset_mode()
    else:
        render_multi_asset_mode()
```

#### 4.3.2 配置状态

**空状态（未选择标的）：**
- 提示信息："请选择至少一个标的来配置策略"
- 标的选择提示

**单标模式：**
- 完整的策略配置面板
- 所有策略类型可选
- 自定义规则编辑器
- 仓位配置

**多标模式：**
- 可折叠的全局默认设置
- 可展开的个别标的配置
- 快速配置选项（应用到所有、从标的复制）
- 自定义配置的视觉指示器

## 5. 实施计划

### 5.1 第一阶段：UI重构
- 创建自适应配置渲染器
- 基于标的数量实现动态UI切换
- 添加视觉层次组件

### 5.2 第二阶段：策略继承
- 实现策略继承逻辑
- 添加配置覆盖机制
- 创建冲突配置的验证

### 5.3 第三阶段：增强功能
- 批量配置操作
- 策略模板和预设
- 配置导出/导入功能

## 6. 技术规范

### 6.1 组件结构
```
src/frontend/strategy_config/
├── adaptive_strategy_config_ui.py     # 主自适应UI控制器
├── single_asset_config_ui.py          # 单标配置
├── multi_asset_config_ui.py           # 多标配置
├── strategy_inheritance_manager.py    # 策略继承逻辑
└── config_validation_service.py       # 配置验证
```

### 6.2 关键类和方法

#### AdaptiveStrategyConfigUI
```python
class AdaptiveStrategyConfigUI:
    def render_configuration(self, selected_options)
    def _determine_configuration_mode(self, asset_count)
    def _render_single_asset_mode(self, selected_options)
    def _render_multi_asset_mode(self, selected_options)
```

#### StrategyInheritanceManager
```python
class StrategyInheritanceManager:
    def get_effective_strategy(self, symbol, global_config, individual_configs)
    def validate_strategy_hierarchy(self, configs)
    def resolve_conflicts(self, configs)
```

### 6.3 状态管理
```python
# Session state 结构
st.session_state.strategy_config = {
    'mode': 'single' | 'multi',
    'global_defaults': {...},
    'individual_configs': {
        'symbol1': {...},
        'symbol2': {...}
    },
    'inheritance_rules': {...}
}
```

## 7. 用户界面原型

### 7.1 单标模式
```
┌─────────────────────────────────────┐
│ 🎯 策略配置                        │
├─────────────────────────────────────┤
│ 策略类型: [下拉菜单 ▼]             │
│ ☐ 自定义规则                       │
│ ┌─────────────────────────────────┐ │
│ │ 自定义规则编辑器                 │ │
│ └─────────────────────────────────┘ │
│ 仓位管理: [配置...]                │
└─────────────────────────────────────┘
```

### 7.2 多标模式
```
┌─────────────────────────────────────┐
│ 🎯 多标策略配置                    │
├─────────────────────────────────────┤
│ [▼] 全局默认设置                   │
│ ├─ 策略类型: [下拉菜单 ▼]         │
│ ├─ 仓位: [配置...]                 │
│ └─ 应用到所有 [按钮]               │
├─────────────────────────────────────┤
│ 个别标的具体配置                   │
│ [▼] AAPL - Apple Inc.              │
│  ├─ ☑ 使用全局默认                 │
│  └─ 策略: 全局默认                 │
│ [▶] MSFT - Microsoft Corp.         │
│  ├─ ☐ 使用自定义策略               │
│  └─ 策略类型: [下拉菜单 ▼]         │
│ [▶] GOOGL - Alphabet Inc.          │
│  ├─ ☐ 使用规则组                   │
│  └─ 规则组: [下拉菜单 ▼]           │
└─────────────────────────────────────┘
```

## 8. 测试策略

### 8.1 单元测试
- 测试自适应UI渲染逻辑
- 测试策略继承解析
- 测试配置验证
- 测试状态管理转换

### 8.2 集成测试
- 测试端到端配置工作流
- 测试多标回测执行
- 测试配置持久化
- 测试错误处理场景

### 8.3 用户验收测试
- 真实用户的可用性测试
- 配置工作流验证
- 大规模标的集的性能测试
- 可访问性合规性测试

## 9. 成功标准

### 9.1 功能需求
- [ ] 基于标的选择的动态UI适配
- [ ] 清晰的策略继承层次
- [ ] 直观的配置工作流
- [ ] 健壮的验证和错误处理

### 9.2 非功能需求
- [ ] 不同屏幕尺寸的响应式设计
- [ ] 与现有UI的一致样式
- [ ] 100+标的的性能支持
- [ ] 可访问性合规（WCAG 2.1）

### 9.3 用户体验目标
- [ ] 配置时间减少50%
- [ ] 90%用户满意度
- [ ] 零用户报告的困惑事件
- [ ] 新用户的直观学习曲线

## 10. 未来考虑

### 10.1 可扩展性
- 支持策略模板和预设
- 配置版本控制和回滚
- 高级批量操作
- 策略性能比较工具

### 10.2 集成机会
- 与策略性能分析连接
- 集成风险管理工具
- 支持外部策略导入
- 基于API的配置管理

### 10.3 维护
- 定期可用性审查
- 性能监控
- 用户反馈收集机制
- 持续改进流程

---

**文档版本**: 1.0
**创建日期**: 2025-11-08
**作者**: 开发团队
**状态**: 草稿
**下次审查**: 2025-11-15