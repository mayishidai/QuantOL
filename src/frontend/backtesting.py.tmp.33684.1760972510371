import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from plotly.subplots import make_subplots
from src.core.strategy.backtesting import BacktestConfig
from src.core.strategy.strategy import FixedInvestmentStrategy
from src.core.data.database import DatabaseManager
from src.services.progress_service import progress_service
from typing import cast
import time
from src.support.log.logger import logger
import numpy as np

# å¯¼å…¥æ–°åˆ›å»ºçš„æ¨¡å—
from src.frontend.backtest_config_manager import BacktestConfigManager
from src.frontend.rule_group_manager import RuleGroupManager
from src.frontend.strategy_mapping_manager import StrategyMappingManager
from src.frontend.backtest_executor import BacktestExecutor
from src.frontend.results_display_manager import ResultsDisplayManager

# å¯¼å…¥æ–°åˆ›å»ºçš„UIç»„ä»¶æ¨¡å—
from src.frontend.backtest_config_ui import BacktestConfigUI
from src.frontend.strategy_config_ui import StrategyConfigUI
from src.frontend.position_config_ui import PositionConfigUI
from src.frontend.results_display_ui import ResultsDisplayUI

# å¯¼å…¥æœåŠ¡æ¨¡å—
from src.frontend.data_loader import DataLoader
from src.frontend.callback_services import CallbackServices
from frontend.event_handlers import EventHandlers

async def show_backtesting_page():
    # åˆå§‹åŒ–ç­–ç•¥ID
    if 'strategy_id' not in st.session_state:
        import uuid
        st.session_state.strategy_id = str(uuid.uuid4())

    # åˆå§‹åŒ–æ‰€æœ‰ç®¡ç†å™¨å®ä¾‹
    config_manager = BacktestConfigManager(st.session_state)
    rule_group_manager = RuleGroupManager(st.session_state)
    strategy_mapping_manager = StrategyMappingManager(st.session_state)
    backtest_executor = BacktestExecutor(st.session_state)
    results_display_manager = ResultsDisplayManager(st.session_state)

    # åˆå§‹åŒ–UIç»„ä»¶
    config_ui = BacktestConfigUI(st.session_state)
    strategy_ui = StrategyConfigUI(st.session_state)
    position_ui = PositionConfigUI(st.session_state)
    results_ui = ResultsDisplayUI(st.session_state)

    # åˆå§‹åŒ–æœåŠ¡
    data_loader = DataLoader(st.session_state)
    callback_services = CallbackServices(st.session_state)
    event_handlers = EventHandlers(st.session_state)

    # åˆå§‹åŒ–é…ç½®å’Œè§„åˆ™ç»„
    config_manager.initialize_session_config()
    rule_group_manager.initialize_default_rule_groups()
    strategy_mapping_manager.initialize_strategy_mapping()

    st.title("ç­–ç•¥å›æµ‹")

    # ä½¿ç”¨æ ‡ç­¾é¡µç»„ç»‡é…ç½®
    config_tab1, config_tab2, config_tab3 = st.tabs(["ğŸ“Š å›æµ‹èŒƒå›´", "âš™ï¸ ç­–ç•¥é…ç½®", "ğŸ“ˆ ä»“ä½é…ç½®"])

    # é…ç½®æ ‡ç­¾é¡µ1: å›æµ‹èŒƒå›´
    with config_tab1:
        config_ui.render_date_config_ui()
        config_ui.render_frequency_config_ui()

        # ä½¿ç”¨BacktestConfigUIç»„ä»¶æ¸²æŸ“è‚¡ç¥¨é€‰æ‹©
        selected_options = await config_ui.render_stock_selection_ui()

        # æ›´æ–°é…ç½®å¯¹è±¡ä¸­çš„è‚¡ç¥¨ä»£ç 
        if selected_options:
            selected_symbols = [symbol[0] for symbol in selected_options]
            # ä½¿ç”¨ç»Ÿä¸€æ¥å£è®¾ç½®ç¬¦å·
            st.session_state.backtest_config.target_symbols = selected_symbols

        # æ˜¾ç¤ºé…ç½®æ‘˜è¦
        config_ui.render_config_summary()

    with config_tab2:
        # ä½¿ç”¨StrategyConfigUIç»„ä»¶æ¸²æŸ“ç­–ç•¥é…ç½®
        default_strategy_type = strategy_ui.render_strategy_selection_ui()
        strategy_ui.render_custom_rules_ui(rule_group_manager, default_strategy_type)
        strategy_ui.render_multi_symbol_strategy_ui(selected_options, rule_group_manager, config_manager)
        strategy_ui.render_strategy_summary()

    with config_tab3:
        # ä½¿ç”¨PositionConfigUIç»„ä»¶æ¸²æŸ“ä»“ä½é…ç½®
        position_ui.render_position_strategy_ui()
        position_ui.render_basic_config_ui()
        position_ui.render_config_summary()
    
    # åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
    if 'start_backtest_clicked' not in st.session_state:
        st.session_state.start_backtest_clicked = False

    # å¸¦å›è°ƒçš„æŒ‰é’®ç»„ä»¶
    def on_backtest_click():
        st.session_state.start_backtest_clicked = not st.session_state.start_backtest_clicked

    if st.button(
        "å¼€å§‹å›æµ‹",
        key="start_backtest",
        on_click=on_backtest_click
    ):
        # ä½¿ç”¨å­˜å‚¨åœ¨session_stateä¸­çš„é…ç½®å¯¹è±¡
        backtest_config = st.session_state.backtest_config

        # ç»Ÿä¸€æ•°æ®åŠ è½½
        symbols = backtest_config.get_symbols()

        if backtest_config.is_multi_symbol():
            # å¤šç¬¦å·æ¨¡å¼
            data = await st.session_state.db.load_multiple_stock_data(
                symbols, backtest_config.start_date, backtest_config.end_date, backtest_config.frequency
            )
            st.info(f"å·²åŠ è½½ {len(data)} åªè‚¡ç¥¨æ•°æ®")
        else:
            # å•ç¬¦å·æ¨¡å¼
            data = await st.session_state.db.load_stock_data(
                symbols[0], backtest_config.start_date, backtest_config.end_date, backtest_config.frequency
            )

        st.write("å›æµ‹ä½¿ç”¨çš„æ•°æ®")
        st.write(data)

        # ä½¿ç”¨BacktestExecutionServiceæ‰§è¡Œå›æµ‹
        from frontend.backtest_execution_service import BacktestExecutionService
        execution_service = BacktestExecutionService(st.session_state)

        # åˆå§‹åŒ–å¼•æ“
        engine = execution_service.initialize_engine(backtest_config, data)

        # æ‰§è¡Œå›æµ‹
        results = execution_service.execute_backtest(engine, backtest_config)

        # å¤„ç†å¤šç¬¦å·å’Œå•ç¬¦å·çš„å‡€å€¼æ•°æ®
        if "combined_equity" in results:
            # å¤šç¬¦å·æ¨¡å¼
            equity_data = results["combined_equity"]
            if "individual" in results:
                individual_results = results["individual"]
        else:
            # å•ç¬¦å·æ¨¡å¼
            equity_data = pd.DataFrame(results["equity_records"])

        # å‡†å¤‡å›¾è¡¨æœåŠ¡
        execution_service.prepare_chart_service(data, equity_data)

        if results:
            st.success("å›æµ‹å®Œæˆï¼")
            
            # ä½¿ç”¨ResultsDisplayUIç»„ä»¶æ˜¾ç¤ºç»“æœ
            results_ui.render_results_tabs(results, backtest_config)
        else:
            st.error("å›æµ‹å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥å‚æ•°")
